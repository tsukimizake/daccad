# memo.txt 設計議論まとめ (2026-02-13)

## 問題: ビルトインファンクター内の節参照が解決されない

### 現象
```
cub :- cube(40, 90, 50).
main :- (cub - rotate(cub, 0, 30, 0)).
```
→ `Resolved terms: [(cube(40, 90, 50) - rotate(cub, 0, 30, 0))]`
→ 左辺の`cub`は解決されるが、`rotate`内の`cub`は解決されない
→ manifold_bridgeで "Unknown primitive: cub" エラー

### 原因
`rewrite_term_recursive`でビルトインファンクター（`rotate`等）に遭遇すると、引数を解決せずそのまま返していた

### 試された修正
- ビルトインファンクターの引数を再帰的に解決するよう変更
- `is_builtin_primitive`に`Term::Number`を追加

### Pros
- `rotate(cub, ...)` → `rotate(cube(...), ...)` と正しく展開

### Cons
- 多くの既存テスト（Prolog的セマンティクス）が壊れる
- スタックオーバーフロー発生（変数が無限にマッチ）
- Prolog的「マッチしなければ失敗」とCAD的「リテラルとして扱う」の衝突

### 最終状態
- セッションがAPI制限で中断後revert
- 完全な解決には至っていない

---

## 未解決の設計課題: セマンティクスの衝突

### 2つのセマンティクス
1. **Prolog的**: クエリの項がDBにマッチしなければ失敗
2. **CAD言語的**: マッチしない項はリテラルとして扱い、manifold_bridgeで検証

現在のテストはProlog的を期待しているが、CAD用途にはCAD的が必要。

### 検討すべき選択肢

#### A. Factマッチ時は引数を再解決しない（Prolog的に戻す）
- Pros: 既存テストが通る、Prologとの互換性
- Cons: `rotate(cub, ...)` が動かない

#### B. ビルトインファンクターのみ引数解決（CAD用に特化）
- Pros: CADユースケースに対応
- Cons: 変数の無限マッチ問題、テスト修正が大量

#### C. 2層構造（term_rewriteはProlog的、manifold_bridge側で節参照を解決）
- Pros: 責務の分離、既存テストへの影響小
- Cons: manifold_bridgeがDBを参照する必要、設計変更が大きい

#### D. 遅延評価（変数・節参照を保持し、最終評価時に解決）
- Pros: 柔軟性が高い
- Cons: 実装が複雑

#### E. ユーザー案 (C案の一種？)

term_rewriteはProlog的に動作し、manifold_bridgeのCAD primitiveをfactとして登録する。

- Pros: Prolog的セマンティクスを保ちつつ、CADユースケースもサポート
- Cons: 実装が大変ではあるかもしれない。それ以外に見つけたらAIくん教えて



---

## 次のアクション候補
- [ ] どのセマンティクスを採用するか決定
- [ ] 選択した方針に基づいてテストを整理
